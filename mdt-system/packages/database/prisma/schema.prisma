generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// =========================================================
// 1. 用户与权限中心 (Users & Experts)
// =========================================================

// SQLite 兼容性说明:
// Role Enum: "ADMIN", "ASSISTANT", "EXPERT"
model User {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String   // 加密存储
  realName  String
  role      String   // 存储 Role Enum
  
  // 专家特有信息
  expertProfile ExpertProfile?
  
  // 参与的任务关联
  expertTasks   TaskExpert[]
  
  // 操作日志关联
  logs          TaskLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ExpertProfile {
  id             String   @id @default(uuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id])
  
  department     String   // 所属科室
  titles         String   // 专家类型标签 (JSON string: ["精神科", "心理治疗"])
  signatureUrl   String?  // 电子签名图片路径 (PRD 4.2.1)
  
  opinions       ExpertOpinion[]
}

// =========================================================
// 2. 会诊任务核心 (Consultation Task)
// =========================================================

// TaskStatus Enum 定义 (PRD 3.3.1):
// - PENDING: 待会诊 (未开始)
// - IN_PROGRESS: 会诊中 (含专家问诊、意见发表阶段)
// - COMPLETED: 已会诊 (等待归档/签名)
// - ARCHIVED: 已归档 (流程结束)
// - OVERDUE: 超期 (系统自动流转)
// - CANCELLED: 已取消 (手动取消)

model ConsultationTask {
  id             String     @id @default(uuid())
  status         String     @default("PENDING") 
  scheduledTime  DateTime   // 预定会诊时间
  
  // 患者基本信息 (敏感信息，生产环境需加密/脱敏)
  patientName    String
  patientGender  String
  patientAge     Int
  chiefComplaint String     // 主诉

  // --- 关联子模块 ---
  preDoc         PreConsultationDoc?
  dialogs        ConsultationDialog[]
  postDoc        PostConsultationDoc?
  opinions       ExpertOpinion[]
  report         ConsultationReport?
  
  experts        TaskExpert[] // 受邀专家列表
  logs           TaskLog[]    // 状态流转日志 (PRD 8.2)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// =========================================================
// 3. 专家调度与邀请 (Expert Scheduling)
// =========================================================

// InvitationStatus Enum: "PENDING", "ACCEPTED", "REJECTED", "CANCELLED"

model TaskExpert {
  id          String           @id @default(uuid())
  taskId      String
  task        ConsultationTask @relation(fields: [taskId], references: [id])
  expertId    String
  expert      User             @relation(fields: [expertId], references: [id])
  
  status      String           @default("PENDING") 
  isCore      Boolean          @default(false) // 核心专家 (权重更高, PRD 4.3.4)
  
  invitedAt   DateTime         @default(now())
  respondedAt DateTime?        // 接受/拒绝的时间

  @@unique([taskId, expertId])
}

// =========================================================
// 4. 全流程文书记录 (Consultation Records)
// =========================================================

// Tab 1: 会诊前文书
model PreConsultationDoc {
  id              String           @id @default(uuid())
  taskId          String           @unique
  task            ConsultationTask @relation(fields: [taskId], references: [id])
  
  presentIllness  String // 现病史
  pastHistory     String? // 既往史
  familyHistory   String? // 家族史
  // 其他选填字段 (婚育史、月经史等) 存为 JSON String
  extraInfo       String?  
}

// Tab 2: 专家问诊 (对话记录)
model ConsultationDialog {
  id        String   @id @default(uuid())
  taskId    String
  task      ConsultationTask @relation(fields: [taskId], references: [id])
  
  role      String   // "DOCTOR" | "PATIENT"
  content   String   // 清洗后的正式文本
  original  String?  // 原始 ASR 识别文本 (留痕)
  startTime Float?   // 录音相对开始时间的偏移量 (秒)
  
  createdAt DateTime @default(now())
}

// Tab 3: 会诊后文书 (PRD 7.1: 需保存 AI 初始版 + 最终提交版)
model PostConsultationDoc {
  id             String           @id @default(uuid())
  taskId         String           @unique
  task           ConsultationTask @relation(fields: [taskId], references: [id])
  
  // 核心字段 (现病史、体格检查等 JSON String)
  aiContent      String?          // AI 生成的初始版本 (不可变，用于归档)
  finalContent   String?          // 助理修改并提交的最终版本
  
  isSubmitted    Boolean          @default(false) // 是否为标星正式版
  version        Int              @default(1)     // 版本号
  
  updatedAt      DateTime         @updatedAt
}

// Tab 4: 专家意见 (Expert Opinions)
model ExpertOpinion {
  id              String           @id @default(uuid())
  taskId          String
  task            ConsultationTask @relation(fields: [taskId], references: [id])
  expertProfileId String
  expert          ExpertProfile    @relation(fields: [expertProfileId], references: [id])
  
  audioUrl        String?          // 原始录音文件路径
  asrText         String?          // ASR 原始转录文本
  
  aiStructured    String?          // AI 生成的结构化意见 (PRD 7.1)
  isAiAdopted     Boolean          @default(false) // 是否采纳了 AI 建议 (PRD 4.3.4)
  
  finalText       String?          // 专家最终提交的意见内容
  isSubmitted     Boolean          @default(false)
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
}

// Tab 5: 会诊报告 (Final Report)
model ConsultationReport {
  id              String           @id @default(uuid())
  taskId          String           @unique
  task            ConsultationTask @relation(fields: [taskId], references: [id])
  
  aiSummary       String?          // AI 生成的原始总结
  finalSummary    String           // 最终修正后的总结
  
  aiEducation     String?          // AI 生成的原始宣教
  finalEducation  String           // 最终修正后的宣教
  
  pdfUrl          String?          // 生成的 PDF 报告路径
  isSigned        Boolean          @default(false) // 是否已完成所有签名
  
  completedAt     DateTime         @default(now())
}

// =========================================================
// 5. 审计与日志 (Logs & Audit)
// =========================================================

// 记录关键状态变更 (PRD 8.2)
model TaskLog {
  id        String   @id @default(uuid())
  taskId    String
  task      ConsultationTask @relation(fields: [taskId], references: [id])
  
  operatorId String? // 操作人 ID (系统自动操作则为空)
  operator   User?   @relation(fields: [operatorId], references: [id])
  
  action    String   // e.g., "STATUS_CHANGE", "INVITE_SENT", "DOC_SUBMITTED"
  details   String?  // JSON String: { from: "PENDING", to: "IN_PROGRESS" }
  
  createdAt DateTime @default(now())
}
